---
import BaseLayout from '../../layouts/BaseLayout.astro';
import NavBar from '../../components/NavBar.astro';
import ArtworkCard from '../../components/ArtworkCard.astro';
import { getArtworkById, getRelatedArtworks, allArtworks } from '../../lib/artworks';

export async function getStaticPaths() {
	return allArtworks.map((artwork) => ({
		params: { id: artwork.objectID.toString() },
	}));
}

const { id } = Astro.params;
const artwork = getArtworkById(Number(id));

if (!artwork) {
	return Astro.redirect('/');
}

const relatedArtworks = getRelatedArtworks(artwork.relatedArtworks);

// Group related artworks into sets of 3
const sets = relatedArtworks.reduce((acc, obj) => {
	if (acc.length === 0 || acc[acc.length - 1].length === 3) {
		acc.push([obj]);
	} else {
		acc[acc.length - 1].push(obj);
	}
	return acc;
}, [] as typeof relatedArtworks[]);

const title = `${artwork.title} - OnView`;
const description = `${artwork.title} by ${artwork.artistDisplayName}. ${artwork.objectDate}. ${artwork.medium}. Discover visually similar artworks from the Metropolitan Museum of Art.`;
const image = artwork.primaryImageSmall;
const url = `https://onview.dev/artwork/${id}`;
---

<BaseLayout title={title} description={description} image={image} url={url}>
	<article>
		<h1>{artwork.title || 'Untitled'}</h1>
		<div class="grid">
			<img src={artwork.primaryImageSmall} alt={artwork.title} class="artwork-image" />
			<div class="artwork-details">
				<p>
					<strong>Artist:</strong>
					{artwork.artistDisplayName || 'Unknown Artist'}
				</p>
				{
					artwork.culture && (
						<p>
							<strong>Culture:</strong> {artwork.culture}
						</p>
					)
				}
				<p>
					<strong>Date:</strong>
					{artwork.objectDate ? artwork.objectDate : 'n/a'}
				</p>
				{
					artwork.medium && (
						<p>
							<strong>Medium:</strong> {artwork.medium}
						</p>
					)
				}
				{
					artwork.dimensions && (
						<p>
							<strong>Dimensions:</strong> {artwork.dimensions}
						</p>
					)
				}
				{
					artwork.galleryNumber && (
						<p>
							<strong>Gallery:</strong> {artwork.galleryNumber}
						</p>
					)
				}
				{
					artwork.isHighlight === 'TRUE' && (
						<p class="highlight">Highlighted Artwork</p>
					)
				}
				{
					artwork.artistDisplayBio && (
						<p>
							<em>{artwork.artistDisplayBio}</em>
						</p>
					)
				}
				<p>
					<a href={`https://www.metmuseum.org/art/collection/search/${artwork.objectID}`}>
						View on metmuseum.org &rarr;
					</a>
				</p>
			</div>
		</div>
	</article>

	<h3>Related:</h3>
	{
		sets.map((set) => (
			<div class="grid">
				{set.map((relatedArtwork) => (
					<ArtworkCard artwork={relatedArtwork} />
				))}
			</div>
		))
	}
</BaseLayout>
