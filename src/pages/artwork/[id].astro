---
import BaseLayout from '../../layouts/BaseLayout.astro';
import MasonryGallery from '../../components/MasonryGallery.astro';
import ArtworkDetails from '../../components/ArtworkDetails.astro';
import {
	getArtworkById,
	getRelatedArtworks,
	allArtworks,
} from '../../lib/artworks';

export async function getStaticPaths() {
	return allArtworks.map((artwork) => ({
		params: { id: artwork.objectID.toString() },
	}));
}

const { id } = Astro.params;
const artwork = getArtworkById(Number(id));

if (!artwork) {
	return Astro.redirect('/');
}

const relatedArtworks = getRelatedArtworks(artwork.relatedArtworks);

const title = `${artwork.title} - OnView`;
const description = `${artwork.title} by ${artwork.artistDisplayName}. ${artwork.objectDate}. ${artwork.medium}. Discover visually similar artworks from the Metropolitan Museum of Art.`;
const image = artwork.primaryImageSmall;
const url = `https://onview.dev/artwork/${id}`;
---

<BaseLayout title={title} description={description} image={image} url={url}>
	<Fragment slot="head">
		<!-- Preload main artwork image for faster LCP -->
		<link
			rel="preload"
			as="image"
			href={artwork.images.medium}
			imagesrcset={`${artwork.images.small} 400w, ${artwork.images.medium} 800w, ${artwork.images.large} 1200w`}
			imagesizes="(max-width: 768px) 100vw, 50vw"
		/>
		<!-- Structured Data for Artwork -->
		<script
			type="application/ld+json"
			set:html={JSON.stringify({
				'@context': 'https://schema.org',
				'@type': 'VisualArtwork',
				name: artwork.title,
				image: artwork.images.medium,
				creator: {
					'@type': 'Person',
					name: artwork.artistDisplayName,
				},
				dateCreated: artwork.objectDate,
				artMedium: artwork.medium,
				artform: 'Painting',
				url: `https://onview.dev/artwork/${id}`,
				isPartOf: {
					'@type': 'Collection',
					name: 'Metropolitan Museum of Art Open Access Collection',
				},
				copyrightNotice: 'CC0 1.0 Universal (CC0 1.0) Public Domain Dedication',
			})}
		/>
	</Fragment>

	<Fragment slot="outside">
		<!-- Absolute info card top right (outside max-width constraint) -->
		<div class="absolute top-30 right-4 max-w-sm z-10 hidden lg:block">
			<ArtworkDetails artwork={artwork} />
		</div>
	</Fragment>

	<article class="mt-12 mb-8" data-pagefind-ignore>
		<!-- Image centered -->
		<div class="flex justify-center mb-8">
			<picture>
				<source
					srcset={`${artwork.images.small} 400w, ${artwork.images.medium} 800w, ${artwork.images.large} 1200w`}
					sizes="(max-width: 768px) 100vw, 90vw"
					type="image/webp"
				/>
				<img
					src={artwork.images.medium}
					alt={artwork.title}
					class="w-full max-w-4xl h-auto rounded-lg"
					loading="eager"
					data-pagefind-meta="image[src]"
				/>
			</picture>
		</div>

		<!-- Mobile/tablet info card below image -->
		<div class="lg:hidden max-w-2xl mx-auto mb-8" data-pagefind-ignore>
			<ArtworkDetails artwork={artwork} />
		</div>
	</article>

	<!-- Related Artworks -->
	<div
		id="related-section"
		class="container mx-auto px-4 py-12"
		data-pagefind-ignore
	>
		<h3 id="related" class="text-2xl text-center text-primary mb-6">Related</h3>

		<MasonryGallery artworks={relatedArtworks} eagerCount={4} />
	</div>

	<!-- Floating button to Related section -->
	<a
		id="related-button"
		href="#related"
		class="fixed bottom-8 right-8 bg-gray-warm-900/90 hover:bg-gray-warm-900 border border-gray-warm-700/80 hover:border-gray-warm-700 text-primary px-6 py-3 rounded-full transition-all z-50 items-center gap-2 hidden"
		aria-label="Jump to related artworks"
	>
		<span>Related Artworks</span>
		<span class="text-xl -translate-y-0.5">&darr;</span>
	</a>
</BaseLayout>

<style>
	html {
		scroll-behavior: smooth;
	}

	#related-button.hidden {
		opacity: 0;
		pointer-events: none;
	}
</style>

<script>
	const button = document.getElementById('related-button');
	const relatedHeading = document.getElementById('related');

	function checkScrollPosition() {
		if (!relatedHeading || !button) return;

		const rect = relatedHeading.getBoundingClientRect();
		const windowHeight = window.innerHeight;
		const threshold = windowHeight * (4 / 5);

		if (rect.top <= threshold) {
			button.classList.add('hidden');
		} else {
			button.classList.remove('hidden');
		}
	}

	window.addEventListener('scroll', checkScrollPosition);
	window.addEventListener('load', checkScrollPosition);

	checkScrollPosition();
</script>
