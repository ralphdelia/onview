---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ImageItem from '../../components/ImageItem.astro';
import ArtworkDetails from '../../components/ArtworkDetails.astro';
import { getArtworkById, getRelatedArtworks, allArtworks } from '../../lib/artworks';
import { Masonry } from 'astro-masonry';

export async function getStaticPaths() {
	return allArtworks.map((artwork) => ({
		params: { id: artwork.objectID.toString() },
	}));
}

const { id } = Astro.params;
const artwork = getArtworkById(Number(id));

if (!artwork) {
	return Astro.redirect('/');
}

const relatedArtworks = getRelatedArtworks(artwork.relatedArtworks);

const title = `${artwork.title} - OnView`;
const description = `${artwork.title} by ${artwork.artistDisplayName}. ${artwork.objectDate}. ${artwork.medium}. Discover visually similar artworks from the Metropolitan Museum of Art.`;
const image = artwork.primaryImageSmall;
const url = `https://onview.dev/artwork/${id}`;
---

<BaseLayout title={title} description={description} image={image} url={url}>
	<Fragment slot="head">
		<!-- Preload main artwork image for faster LCP -->
		<link
			rel="preload"
			as="image"
			href={artwork.images.medium}
			imagesrcset={`${artwork.images.small} 400w, ${artwork.images.medium} 800w, ${artwork.images.large} 1200w`}
			imagesizes="(max-width: 768px) 100vw, 50vw"
		/>
	</Fragment>

	<Fragment slot="outside">
		<!-- Absolute info card top right (outside max-width constraint) -->
		<div class="absolute top-23 right-4 max-w-sm z-10 hidden lg:block">
			<ArtworkDetails artwork={artwork} />
		</div>
	</Fragment>

	<article class="py-8" data-pagefind-ignore>
		<!-- Image centered -->
		<div class="flex justify-center mb-8">
			<picture>
				<source
					srcset={`${artwork.images.small} 400w, ${artwork.images.medium} 800w, ${artwork.images.large} 1200w`}
					sizes="(max-width: 768px) 100vw, 90vw"
					type="image/webp"
				/>
				<img
					src={artwork.images.medium}
					alt={artwork.title}
					class="w-full max-w-4xl h-auto rounded-lg"
					loading="eager"
					data-pagefind-meta="image[src]"
				/>
			</picture>
		</div>

		<!-- Mobile/tablet info card below image -->
		<div class="lg:hidden max-w-2xl mx-auto mb-8" data-pagefind-ignore>
			<ArtworkDetails artwork={artwork} />
		</div>
	</article>

	<!-- Related Artworks -->
	<div id="related-section" class="container mx-auto px-4 py-12" data-pagefind-ignore>
		<h3 class="text-2xl font-bold text-white mb-6">Related:</h3>

		<Masonry
			breakpointCols={{default: 4, 1280: 3, 900: 2, 640: 1}}
			class="masonry-grid"
			columnClass="masonry-column"
		>
			{relatedArtworks.map((relatedArtwork) => (
				<ImageItem artwork={relatedArtwork} lazy={true} />
			))}
		</Masonry>
	</div>

	<style>
		:global(.masonry-grid) {
			margin-left: -1rem;
		}

		:global(.masonry-column) {
			padding-left: 1rem;
			background-clip: padding-box;
		}

		:global(.masonry-column > *) {
			margin-bottom: 1rem;
		}
	</style>
</BaseLayout>
